<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó –ê–≤—Ç–æ –†—É–ª–µ—Ç–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 6px 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 12px;
            border: none;
            color: white;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            font-weight: bold;
        }

        .special-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .special-tab {
            background: rgba(255,215,0,0.2);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 12px;
            border: 1px solid rgba(255,215,0,0.5);
            color: #FFD700;
        }

        .special-tab.active {
            background: rgba(255,215,0,0.4);
            font-weight: bold;
        }

        .global-stats {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .queue-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .queue-info {
            text-align: center;
            margin-bottom: 10px;
        }

        .queue-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .queue-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-item.current {
            background: linear-gradient(45deg, rgba(255,215,0,0.3), rgba(255,165,0,0.3));
            border-left: 4px solid #FFD700;
        }

        .queue-position {
            background: #FF6B6B;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .roulette-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .roulette-display {
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-display {
            font-size: 28px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .spin-button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255,107,107,0.4);
        }

        .spin-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .spin-button.current-turn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }

        .solo-button {
            background: linear-gradient(45deg, #FFD700, #FFA500) !important;
        }

        .trade-button {
            background: linear-gradient(45deg, #9333EA, #7C3AED) !important;
            margin-top: 10px;
        }

        .inventory-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .inventory-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .number-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            margin: 8px 0;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #4ECDC4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .number-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .number-item.favorite {
            background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2));
            border-left: 4px solid #FFD700;
        }

        .number-item.special {
            background: linear-gradient(45deg, rgba(147,51,234,0.2), rgba(79,70,229,0.2));
            border-left: 4px solid #9333EA;
        }

        .number-item.selected {
            background: linear-gradient(45deg, rgba(34,197,94,0.3), rgba(21,128,61,0.3));
            border-left: 4px solid #22C55E;
            transform: scale(1.02);
        }

        .favorite-star {
            color: #FFD700;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .favorite-star:hover {
            transform: scale(1.3);
        }

        .trade-icon {
            color: #9333EA;
            font-size: 16px;
            margin-left: 5px;
            cursor: pointer;
        }

        .empty-inventory {
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-style: italic;
            padding: 20px;
        }

        .current-turn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D) !important;
            color: white;
        }

        .timer {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .game-mode {
            text-align: center;
            font-size: 12px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .trade-section {
            background: rgba(147,51,234,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(147,51,234,0.5);
        }

        .trade-info {
            text-align: center;
            margin-bottom: 10px;
            color: #E9D5FF;
        }

        @keyframes spin {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .spinning {
            animation: spin 0.3s ease-in-out infinite;
        }

        .waiting {
            opacity: 0.7;
        }

        .special-badge {
            background: linear-gradient(45deg, #9333EA, #7C3AED);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó –ê–≤—Ç–æ –†—É–ª–µ—Ç–∫–∞</h1>
            <div class="stats">
                <div class="stat-item">
                    <span>üì¶ –í—Å–µ–≥–æ:</span>
                    <span id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ:</span>
                    <span id="favoriteCount">0</span>
                </div>
                <div class="stat-item">
                    <span>üéØ –í –æ—á–µ—Ä–µ–¥–∏:</span>
                    <span id="queuePosition">-</span>
                </div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="all">–í—Å–µ –Ω–æ–º–µ—Ä–∞</div>
            <div class="tab" data-tab="favorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</div>
            <div class="tab" data-tab="trade">üîÑ –û–±–º–µ–Ω</div>
        </div>

        <div class="special-tabs">
            <div class="special-tab" data-tab="special_numbers">üî¢ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã</div>
            <div class="special-tab" data-tab="special_letters">üî§ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±—É–∫–≤—ã</div>
        </div>

        <div class="global-stats">
            <div>üöó –°–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤: <span id="remainingNumbers">0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 100%"></div>
            </div>
            <div class="timer" id="numbersTimer">–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Å–µ–π—á–∞—Å</div>
        </div>

        <div class="trade-section" id="tradeSection" style="display: none;">
            <div class="trade-info">
                <div>üîÑ –†–µ–∂–∏–º –æ–±–º–µ–Ω–∞ - –≤—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –¥–ª—è –æ–±–º–µ–Ω–∞</div>
                <div class="timer">–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span> –Ω–æ–º–µ—Ä–æ–≤</div>
            </div>
            <button class="spin-button trade-button" id="confirmTradeButton" disabled>
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–±–º–µ–Ω
            </button>
        </div>

        <div class="queue-section">
            <div class="queue-info">
                <div>üéØ –¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="currentPlayer">-</span></div>
                <div class="timer" id="turnTimer">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
            </div>
            <div class="queue-list" id="queueList">
                <div class="empty-inventory">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</div>
            </div>
        </div>

        <div class="roulette-section">
            <div class="game-mode" id="gameModeInfo">
                üí´ –û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞ - –∫—Ä—É—Ç–∏ —Å—Ä–∞–∑—É!
            </div>
            <div class="roulette-display" id="rouletteDisplay">
                <div class="number-display" id="currentNumber">–ù–∞–∂–º–∏ "–ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É"</div>
            </div>
            <button class="spin-button" id="spinButton">
                üé∞ –ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É
            </button>
            <button class="spin-button solo-button" id="soloButton" style="display: none; margin-top: 10px;">
                üí´ –ö—Ä—É—Ç–∏—Ç—å –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏
            </button>
        </div>

        <div class="inventory-section">
            <h3 id="inventoryTitle">üì¶ –í—Å–µ –Ω–æ–º–µ—Ä–∞</h3>
            <div class="inventory-list" id="inventoryList">
                <div class="empty-inventory">–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥
        const firebaseConfig = {
            apiKey: "AIzaSyCatvL7x0qlNY0TWGCtlOxoDyNKbkbllq0",
            authDomain: "car-number-be139.firebaseapp.com",
            projectId: "car-number-be139",
            storageBucket: "car-number-be139.firebasestorage.app",
            messagingSenderId: "523988838128",
            appId: "1:523988838128:web:8784eec711c44148d70435"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û –ö–û–ú–ë–ò–ù–ê–¶–ò–ô
        const LETTERS = [
            '–ê', '–ë', '–í', '–ì', '–î', '–ï', '–Å', '–ñ', '–ó', '–ò', '–ô', '–ö', '–õ', '–ú', 
            '–ù', '–û', '–ü', '–†', '–°', '–¢', '–£', '–§', '–•', '–¶', '–ß', '–®', '–©', '–™', 
            '–´', '–¨', '–≠', '–Æ', '–Ø'
        ];

        // 999 –Ω–æ–º–µ—Ä–æ–≤ –æ—Ç 001 –¥–æ 999
        const NUMBERS = Array.from({length: 999}, (_, i) => 
            (i + 1).toString().padStart(3, '0')
        );

        // –í–°–ï —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏ –æ—Ç 01 –¥–æ 999
        const REGIONS = Array.from({length: 999}, (_, i) => 
            (i + 1).toString().padStart(2, '0')
        ).concat([
            '102', '113', '116', '121', '123', '124', '125', '126', '134', '136',
            '138', '142', '147', '150', '152', '154', '156', '159', '161', '163',
            '164', '173', '174', '177', '178', '186', '190', '196', '197', '199',
            '277', '299', '377', '399', '477', '499', '577', '599', '677', '699',
            '777', '799', '877', '899', '977', '999'
        ]);

        const TOTAL_COMBINATIONS = (LETTERS.length ** 3) * NUMBERS.length * REGIONS.length;

        class QueueGame {
            constructor() {
                this.userId = this.getUserId();
                this.userName = this.getUserName();
                this.collection = [];
                this.queue = [];
                this.usedNumbers = new Set();
                this.isMyTurn = false;
                this.isSpinning = false;
                this.turnTimeout = null;
                this.currentTab = 'all';
                this.specialTab = null;
                this.gameMode = 'solo';
                this.selectedNumbers = new Set();
                this.tradeMode = false;
                
                this.initializeElements();
                this.startRealTimeListeners();
                this.loadUserData();
                this.startAutoSkipTimer();
            }
            
            getUserId() {
                if (window.Telegram && Telegram.WebApp) {
                    return 'tg_' + Telegram.WebApp.initDataUnsafe.user.id;
                }
                let userId = localStorage.getItem('carRouletteUserId');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('carRouletteUserId', userId);
                }
                return userId;
            }
            
            getUserName() {
                if (window.Telegram && Telegram.WebApp) {
                    return Telegram.WebApp.initDataUnsafe.user.first_name || '–ò–≥—Ä–æ–∫';
                }
                return '–ò–≥—Ä–æ–∫_' + Math.random().toString(36).substr(2, 5);
            }

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –±—É–∫–≤
            hasThreeSameLetters(numberStr) {
                try {
                    const lettersPart = numberStr.split(' ')[0];
                    const letters = lettersPart.replace(/\d/g, '');
                    
                    if (letters.length >= 3) {
                        return letters[0] === letters[1] && letters[1] === letters[2];
                    }
                    return false;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É–∫–≤:', error);
                    return false;
                }
            }

            hasThreeSameNumbers(numberStr) {
                try {
                    const numbersPart = numberStr.split(' ')[0];
                    const numbers = numbersPart.match(/\d+/g);
                    
                    if (numbers && numbers[0] && numbers[0].length === 3) {
                        const num = numbers[0];
                        return num[0] === num[1] && num[1] === num[2];
                    }
                    return false;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–∏—Ñ—Ä:', error);
                    return false;
                }
            }

            isSpecialNumber(numberData) {
                if (this.specialTab === 'special_numbers') {
                    return this.hasThreeSameNumbers(numberData.number);
                } else if (this.specialTab === 'special_letters') {
                    return this.hasThreeSameLetters(numberData.number);
                }
                return false;
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–º–µ–Ω–∞
            toggleTradeMode() {
                this.tradeMode = !this.tradeMode;
                this.selectedNumbers.clear();
                
                const tradeSection = document.getElementById('tradeSection');
                const confirmButton = document.getElementById('confirmTradeButton');
                
                if (this.tradeMode) {
                    tradeSection.style.display = 'block';
                    confirmButton.disabled = true;
                } else {
                    tradeSection.style.display = 'none';
                    confirmButton.disabled = true;
                }
                
                this.updateInventory();
                this.updateSelectedCount();
            }

            toggleNumberSelection(numberId) {
                if (!this.tradeMode) return;
                
                if (this.selectedNumbers.has(numberId)) {
                    this.selectedNumbers.delete(numberId);
                } else {
                    this.selectedNumbers.add(numberId);
                }
                
                const confirmButton = document.getElementById('confirmTradeButton');
                confirmButton.disabled = this.selectedNumbers.size === 0;
                
                this.updateInventory();
                this.updateSelectedCount();
            }

            updateSelectedCount() {
                document.getElementById('selectedCount').textContent = this.selectedNumbers.size;
            }

            async confirmTrade() {
                if (this.selectedNumbers.size === 0) return;
                
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±–º–µ–Ω–∞ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
                // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                alert(`–í—ã–±—Ä–∞–Ω–æ ${this.selectedNumbers.size} –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞! –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏.`);
                
                this.selectedNumbers.clear();
                this.tradeMode = false;
                document.getElementById('tradeSection').style.display = 'none';
                this.updateInventory();
            }
            
            async startRealTimeListeners() {
                db.collection('gameQueue').orderBy('joinedAt', 'asc')
                    .onSnapshot(snapshot => {
                        this.queue = [];
                        snapshot.forEach(doc => {
                            this.queue.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateQueueDisplay();
                        this.updateGameMode();
                        this.autoStartGame();
                    });
                
                db.collection('usedNumbers').onSnapshot(snapshot => {
                    this.usedNumbers = new Set();
                    snapshot.forEach(doc => {
                        this.usedNumbers.add(doc.id);
                    });
                    this.updateRemainingNumbers();
                });
                
                db.collection('gameState').doc('current')
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            this.currentPlayer = data.currentPlayer;
                            this.isMyTurn = this.currentPlayer === this.userId;
                            this.lastTurnTime = data.lastTurnTime?.toDate();
                            this.updateCurrentPlayer();
                            this.updateSpinButton();
                            this.updateTimers();
                        }
                    });
            }

            async startAutoSkipTimer() {
                setInterval(async () => {
                    await this.checkTurnTimeout();
                }, 5000);
            }

            async checkTurnTimeout() {
                if (this.currentPlayer && this.lastTurnTime) {
                    const timeSinceLastTurn = Date.now() - this.lastTurnTime.getTime();
                    const turnTimeLimit = 30000;
                    
                    if (timeSinceLastTurn > turnTimeLimit) {
                        console.log('üö® –ê–í–¢–û–°–ö–ò–ü: –ò–≥—Ä–æ–∫', this.currentPlayer, '–ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è');
                        
                        const currentPlayerIndex = this.queue.findIndex(player => player.id === this.currentPlayer);
                        const nextPlayer = this.queue[currentPlayerIndex + 1];
                        
                        if (nextPlayer) {
                            await db.collection('gameState').doc('current').set({
                                currentPlayer: nextPlayer.id,
                                lastTurnTime: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            await db.collection('gameQueue').doc(this.currentPlayer).delete();
                        } else {
                            await db.collection('gameState').doc('current').set({
                                currentPlayer: null,
                                lastTurnTime: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }
            }

            updateGameMode() {
                const gameModeInfo = document.getElementById('gameModeInfo');
                const soloButton = document.getElementById('soloButton');
                
                if (this.queue.length >= 2) {
                    this.gameMode = 'queue';
                    gameModeInfo.textContent = 'üë• –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä - –∂–¥–∏ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏';
                    soloButton.style.display = 'none';
                } else {
                    this.gameMode = 'solo';
                    gameModeInfo.textContent = 'üí´ –û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞ - –∫—Ä—É—Ç–∏ —Å—Ä–∞–∑—É!';
                    soloButton.style.display = 'block';
                }
            }

            async autoStartGame() {
                if (this.queue.length >= 2 && !this.currentPlayer) {
                    console.log('üéÆ –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞ —Å', this.queue.length, '–∏–≥—Ä–æ–∫–∞–º–∏');
                    await this.startFirstTurn();
                }
            }
            
            async loadUserData() {
                try {
                    const doc = await db.collection('users').doc(this.userId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        this.collection = data.collection || [];
                        this.updateDisplay();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                }
            }
            
            async joinQueue() {
                if (this.queue.some(player => player.id === this.userId)) {
                    return;
                }
                
                try {
                    await db.collection('gameQueue').doc(this.userId).set({
                        name: this.userName,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    if (this.queue.length === 0 && !this.currentPlayer) {
                        await this.startFirstTurn();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –æ—á–µ—Ä–µ–¥—å:', error);
                }
            }
            
            async startFirstTurn() {
                const firstPlayer = this.queue[0];
                if (firstPlayer) {
                    console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä, –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫:', firstPlayer.name);
                    await db.collection('gameState').doc('current').set({
                        currentPlayer: firstPlayer.id,
                        lastTurnTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }
            
            async takeTurn() {
                if (this.gameMode === 'queue' && !this.isMyTurn) return;
                
                this.isSpinning = true;
                this.spinButton.disabled = true;
                this.rouletteDisplay.classList.add('spinning');
                
                for (let i = 0; i < 15; i++) {
                    const tempNumber = this.generateNumber();
                    this.currentNumber.textContent = tempNumber;
                    await this.delay(100 + (i * 5));
                }
                
                let uniqueNumber;
                let attempts = 0;
                do {
                    uniqueNumber = this.generateNumber();
                    attempts++;
                    if (attempts > 100) {
                        uniqueNumber = this.generateNumber() + " (–¥—É–±–ª—å)";
                        break;
                    }
                } while (this.usedNumbers.has(uniqueNumber));
                
                this.currentNumber.textContent = uniqueNumber;
                await this.saveNumber(uniqueNumber);
                
                if (this.gameMode === 'queue') {
                    await this.passTurn();
                }
                
                this.rouletteDisplay.classList.remove('spinning');
                this.isSpinning = false;
                this.spinButton.disabled = false;
            }
            
            async passTurn() {
                const currentIndex = this.queue.findIndex(player => player.id === this.userId);
                const nextPlayer = this.queue[currentIndex + 1];
                
                if (nextPlayer) {
                    await db.collection('gameState').doc('current').set({
                        currentPlayer: nextPlayer.id,
                        lastTurnTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await db.collection('gameState').doc('current').set({
                        currentPlayer: null,
                        lastTurnTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await db.collection('gameQueue').doc(this.userId).delete();
            }
            
            generateNumber() {
                const letter1 = LETTERS[Math.floor(Math.random() * LETTERS.length)];
                const letter2 = LETTERS[Math.floor(Math.random() * LETTERS.length)];
                const letter3 = LETTERS[Math.floor(Math.random() * LETTERS.length)];
                const number = NUMBERS[Math.floor(Math.random() * NUMBERS.length)];
                const region = REGIONS[Math.floor(Math.random() * REGIONS.length)];
                
                return `${letter1}${number}${letter2}${letter3} ${region}`;
            }
            
            async saveNumber(number) {
                await db.collection('usedNumbers').doc(number).set({
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    usedBy: this.userId
                });
                
                const numberData = {
                    id: this.userId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    number: number,
                    timestamp: new Date().toLocaleString('ru-RU'),
                    isFavorite: false,
                    hasThreeSameNumbers: this.hasThreeSameNumbers(number),
                    hasThreeSameLetters: this.hasThreeSameLetters(number)
                };
                
                this.collection.unshift(numberData);
                await this.saveUserData();
                this.updateDisplay();
            }

            async toggleFavorite(numberId) {
                if (this.tradeMode) {
                    this.toggleNumberSelection(numberId);
                    return;
                }
                
                const number = this.collection.find(item => item.id === numberId);
                if (number) {
                    number.isFavorite = !number.isFavorite;
                    await this.saveUserData();
                    this.updateDisplay();
                }
            }

            async saveUserData() {
                try {
                    await db.collection('users').doc(this.userId).set({
                        collection: this.collection,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                }
            }
            
            initializeElements() {
                this.spinButton = document.getElementById('spinButton');
                this.soloButton = document.getElementById('soloButton');
                this.rouletteDisplay = document.getElementById('rouletteDisplay');
                this.currentNumber = document.getElementById('currentNumber');
                this.inventoryList = document.getElementById('inventoryList');
                this.inventoryTitle = document.getElementById('inventoryTitle');
                this.queueList = document.getElementById('queueList');
                this.currentPlayerElement = document.getElementById('currentPlayer');
                this.queuePositionElement = document.getElementById('queuePosition');
                this.totalCount = document.getElementById('totalCount');
                this.favoriteCount = document.getElementById('favoriteCount');
                this.remainingNumbersElement = document.getElementById('remainingNumbers');
                this.progressFill = document.getElementById('progressFill');
                this.turnTimer = document.getElementById('turnTimer');
                this.numbersTimer = document.getElementById('numbersTimer');
                this.confirmTradeButton = document.getElementById('confirmTradeButton');
                
                this.spinButton.addEventListener('click', () => {
                    if (this.gameMode === 'queue') {
                        if (this.isMyTurn) {
                            this.takeTurn();
                        } else {
                            this.joinQueue();
                        }
                    } else {
                        this.takeTurn();
                    }
                });

                this.soloButton.addEventListener('click', () => {
                    this.takeTurn();
                });

                this.confirmTradeButton.addEventListener('click', () => {
                    this.confirmTrade();
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentTab = e.target.dataset.tab;
                        
                        if (this.currentTab === 'trade') {
                            this.toggleTradeMode();
                        } else {
                            this.tradeMode = false;
                            document.getElementById('tradeSection').style.display = 'none';
                            this.selectedNumbers.clear();
                        }
                        
                        this.specialTab = null;
                        document.querySelectorAll('.special-tab').forEach(t => t.classList.remove('active'));
                        this.updateInventory();
                        this.updateTitle();
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.special-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const clickedTab = e.target.dataset.tab;
                        if (this.specialTab === clickedTab) {
                            this.specialTab = null;
                            e.target.classList.remove('active');
                        } else {
                            this.specialTab = clickedTab;
                            document.querySelectorAll('.special-tab').forEach(t => t.classList.remove('active'));
                            e.target.classList.add('active');
                        }
                        this.updateInventory();
                        this.updateTitle();
                    });
                });

                setInterval(() => this.updateTimers(), 1000);
            }

            updateDisplay() {
                const favoriteCount = this.collection.filter(item => item.isFavorite).length;
                this.totalCount.textContent = this.collection.length;
                this.favoriteCount.textContent = favoriteCount;
                
                this.updateInventory();
                this.updateTitle();
            }

            updateTitle() {
                let title = 'üì¶ –í—Å–µ –Ω–æ–º–µ—Ä–∞';
                
                if (this.currentTab === 'favorites') {
                    title = '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞';
                } else if (this.currentTab === 'trade') {
                    title = 'üîÑ –í—ã–±–æ—Ä –¥–ª—è –æ–±–º–µ–Ω–∞';
                } else if (this.specialTab === 'special_numbers') {
                    title = 'üî¢ –ù–æ–º–µ—Ä–∞ —Å 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏';
                } else if (this.specialTab === 'special_letters') {
                    title = 'üî§ –ù–æ–º–µ—Ä–∞ —Å 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –±—É–∫–≤–∞–º–∏';
                }
                
                this.inventoryTitle.textContent = title;
            }
            
            updateQueueDisplay() {
                const myPosition = this.queue.findIndex(player => player.id === this.userId) + 1;
                
                if (this.queue.length === 0) {
                    this.queueList.innerHTML = '<div class="empty-inventory">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</div>';
                    this.queuePositionElement.textContent = '-';
                    return;
                }
                
                this.queueList.innerHTML = this.queue.map((player, index) => `
                    <div class="queue-item ${player.id === this.currentPlayer ? 'current' : ''} 
                                         ${player.id === this.userId ? 'current-turn' : ''}">
                        <span>${player.name || '–ò–≥—Ä–æ–∫'}</span>
                        <span class="queue-position">${index + 1}</span>
                    </div>
                `).join('');
                
                this.queuePositionElement.textContent = myPosition > 0 ? myPosition : '-';
            }
            
            updateCurrentPlayer() {
                const currentPlayerData = this.queue.find(player => player.id === this.currentPlayer);
                this.currentPlayerElement.textContent = currentPlayerData ? 
                    (currentPlayerData.name || '–ò–≥—Ä–æ–∫') : '–ù–µ—Ç';
            }
            
            updateSpinButton() {
                if (this.gameMode === 'queue') {
                    if (this.isMyTurn) {
                        this.spinButton.textContent = 'üé∞ –ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É';
                        this.spinButton.disabled = this.isSpinning;
                        this.spinButton.classList.add('current-turn');
                        this.rouletteDisplay.classList.remove('waiting');
                    } else {
                        this.spinButton.textContent = this.queue.some(player => player.id === this.userId) 
                            ? '‚è≥ –í –æ—á–µ—Ä–µ–¥–∏...' 
                            : 'üéØ –í—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å';
                        this.spinButton.disabled = this.queue.some(player => player.id === this.userId);
                        this.spinButton.classList.remove('current-turn');
                        this.rouletteDisplay.classList.add('waiting');
                    }
                } else {
                    this.spinButton.textContent = 'üé∞ –ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É';
                    this.spinButton.disabled = this.isSpinning;
                    this.spinButton.classList.remove('current-turn');
                    this.rouletteDisplay.classList.remove('waiting');
                }
            }
            
            updateInventory() {
                let displayCollection = this.collection;
                
                // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                if (this.currentTab === 'favorites') {
                    displayCollection = this.collection.filter(item => item.isFavorite);
                }
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                if (this.specialTab) {
                    displayCollection = displayCollection.filter(item => this.isSpecialNumber(item));
                }
                
                if (displayCollection.length === 0) {
                    let emptyText = '–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤';
                    if (this.currentTab === 'favorites') emptyText = '–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤';
                    if (this.currentTab === 'trade') emptyText = '–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –æ–±–º–µ–Ω–∞';
                    if (this.specialTab === 'special_numbers') emptyText = '–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ —Å 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏';
                    if (this.specialTab === 'special_letters') emptyText = '–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ —Å 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –±—É–∫–≤–∞–º–∏';
                    
                    this.inventoryList.innerHTML = `<div class="empty-inventory">${emptyText}</div>`;
                    return;
                }
                
                this.inventoryList.innerHTML = displayCollection
                    .map(item => {
                        const isSpecial = this.isSpecialNumber(item);
                        const isSelected = this.selectedNumbers.has(item.id);
                        const badges = [];
                        if (item.hasThreeSameNumbers) badges.push('üî¢');
                        if (item.hasThreeSameLetters) badges.push('üî§');
                        
                        return `
                        <div class="number-item ${item.isFavorite ? 'favorite' : ''} 
                                              ${isSpecial ? 'special' : ''}
                                              ${isSelected ? 'selected' : ''}" 
                             onclick="game.toggleFavorite('${item.id}')">
                            <div>
                                <div>üöó ${item.number} ${badges.join(' ')}</div>
                                <div style="font-size: 10px; opacity: 0.7;">${item.timestamp}</div>
                            </div>
                            <span class="favorite-star">${this.tradeMode ? (isSelected ? '‚úÖ' : '‚ö™') : (item.isFavorite ? '‚≠ê' : '‚òÜ')}</span>
                        </div>
                    `}).join('');
            }
            
            updateRemainingNumbers() {
                const remaining = TOTAL_COMBINATIONS - this.usedNumbers.size;
                const percentage = (remaining / TOTAL_COMBINATIONS) * 100;
                
                this.remainingNumbersElement.textContent = remaining.toLocaleString('ru-RU');
                this.progressFill.style.width = percentage + '%';
                this.numbersTimer.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('ru-RU');
            }
            
            updateTimers() {
                if (this.lastTurnTime) {
                    const timeSinceLastTurn = Date.now() - this.lastTurnTime.getTime();
                    const timeLeft = Math.max(0, 30000 - timeSinceLastTurn);
                    
                    if (timeLeft > 0) {
                        this.turnTimer.textContent = `–í—Ä–µ–º—è —Ö–æ–¥–∞: ${Math.ceil(timeLeft / 1000)}—Å`;
                    } else {
                        this.turnTimer.textContent = '‚è∞ –•–æ–¥ —Å–∫–æ—Ä–æ –ø–µ—Ä–µ–π–¥–µ—Ç...';
                    }
                } else {
                    this.turnTimer.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...';
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        let game;
        document.addEventListener('DOMContentLoaded', () => {
            game = new QueueGame();
        });
    </script>
</body>
</html>
